# 后端配合文档 - 默认头像系统

## 📋 概述

前端已实现默认头像系统，所有用户根据ID自动分配彩色头像。**但后端需要配合进行一些调整。**

---

## ⚠️ 当前问题

### 问题1：后端返回微信临时头像URL

**现状**：
```json
{
  "id": 1,
  "nickname": "微信用户",
  "avatar": "https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132"
}
```

**问题**：
- 前端会优先使用后端返回的头像URL  
- 微信头像URL会覆盖前端的默认头像设置
- 导致无法显示彩色默认头像

**解决方案**：
后端在存储和返回用户信息时，**avatar字段应该为null或空字符串**，不要存储微信头像URL。

---

## ✅ 建议修改

### 修改1：用户登录时不保存微信头像

**当前代码**（推测）：
```javascript
// POST /api/auth/login
router.post('/login', async (req, res) => {
  const { code, userInfo } = req.body
  
  // ❌ 问题：保存了微信的avatarUrl
  const user = await User.create({
    nickname: userInfo.nickName,
    avatar: userInfo.avatarUrl,  // ❌ 不要保存这个
    openId: openId
  })
})
```

**修改后**：
```javascript
// POST /api/auth/login
router.post('/login', async (req, res) => {
  const { code, userInfo } = req.body
  
  // ✅ 正确：不保存avatar，或设为null
  const user = await User.create({
    nickname: userInfo.nickName,
    avatar: null,  // ✅ 设为null，让前端使用默认头像
    openId: openId
  })
})
```

### 修改2：数据库已有数据的处理

如果数据库中已经有微信头像URL，建议：

**方案A：数据库迁移（推荐）**
```sql
-- 清空所有微信头像URL
UPDATE users 
SET avatar = NULL 
WHERE avatar LIKE 'https://thirdwx.qlogo.cn/%';
```

**方案B：API返回时过滤**
```javascript
// 任何返回用户信息的API
const getUserData = (user) => ({
  id: user.id,
  nickname: user.nickname,
  avatar: null,  // 强制返回null，不返回微信URL
  campus: user.campus
})
```

---

## 🎯 前端默认头像规则

前端会根据用户ID自动分配头像：

```javascript
用户ID % 5 = 头像索引

例如：
- 用户ID = 1 → 1 % 5 = 1 → 绿色树木头像
- 用户ID = 2 → 2 % 5 = 2 → 橙色山峰头像
- 用户ID = 5 → 5 % 5 = 0 → 蓝色房子头像
```

**关键**：
- 只要后端返回用户ID，前端就能自动分配头像
- 后端**不需要**存储和返回头像URL
- 所有用户在所有设备上看到的**同一个用户的头像都是一样的**

---

## 📝 需要修改的API列表

### 1. POST /api/auth/login
- ✅ 不保存 `avatarUrl`
- ✅ avatar字段设为 `null`

### 2. PUT /api/users/profile
- ✅ 如果前端传来avatar，忽略它（或只接受以 `/images/avatars/default-` 开头的）
- ✅ 不允许用户上传自定义头像

### 3. GET /api/teams （组队列表）
返回的每个team的creator和members中：
- ✅ 只返回 `id`, `nickname`, `campus`, `note`
- ✅ avatar可以不返回，或返回 `null`

### 4. GET /api/team/:id （组队详情）
返回的creator和members中：
- ✅ 只返回 `id`, `nickname`, `campus`, `note`  
- ✅ avatar可以不返回，或返回 `null`

---

## 🔍 验证方法

### 后端修改后，检查API返回：

**正确的返回**：
```json
{
  "id": 1,
  "nickname": "Markus",
  "avatar": null,  // ✅ 或者不返回这个字段
  "campus": "University of Nottingham(Park)"
}
```

**错误的返回**：
```json
{
  "id": 1,
  "nickname": "Markus",
  "avatar": "https://thirdwx.qlogo.cn/...",  // ❌ 不要返回微信URL
  "campus": "University of Nottingham(Park)"
}
```

---

## 💡 后续扩展（可选）

如果后续要支持用户上传自定义头像：

1. **后端**：添加图片上传到云存储的功能
2. **前端**：调用上传API，获得永久URL
3. **后端**：保存永久URL到avatar字段
4. **前端**：优先显示自定义头像，否则使用默认头像

但**现阶段不需要**，使用默认头像即可。

---

## ✅ 总结

**后端只需做一件事**：

> **所有返回用户信息的API，avatar字段设为 `null` 或不返回**

前端会自动处理剩下的一切！🎉

---

## 📞 联系方式

如有疑问，请联系前端开发人员。
