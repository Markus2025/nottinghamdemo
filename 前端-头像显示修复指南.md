# å‰ç«¯å¤´åƒæ˜¾ç¤ºä¿®å¤æŒ‡å—

## ğŸ¯ é—®é¢˜è¯´æ˜

**å½“å‰é—®é¢˜**ï¼šç»„é˜Ÿè¯¦æƒ…é¡µæ˜¾ç¤ºçš„å¤´åƒæ˜¯localStorageä¸­ç¼“å­˜çš„æ—§URLï¼ˆä¸´æ—¶URLï¼‰ï¼Œè€Œä¸æ˜¯APIè¿”å›çš„æ°¸ä¹…URLã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜åŒ–å¤´åƒæ˜¾ç¤ºé€»è¾‘ï¼Œä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„æœ€æ–°æ•°æ®ã€‚

---

## ğŸ“ ä¿®æ”¹å†…å®¹

### æ–‡ä»¶1ï¼š`miniprogram/pages/team-detail/team-detail.js`

#### ä¿®æ”¹ä½ç½®ï¼š`loadTeamDetail` æ–¹æ³•ä¸­çš„æ•°æ®å¤„ç†éƒ¨åˆ†

**ä¿®æ”¹å‰çš„ä»£ç **ï¼ˆå¤§çº¦ç¬¬77-132è¡Œï¼‰ï¼š
```javascript
const teamData = await api.getTeamDetail(teamId);
console.log('ğŸ“Š å®Œæ•´çš„team.creator:', JSON.stringify(teamData.creator, null, 2));
console.log('ğŸ“Š å®Œæ•´çš„team.members:', JSON.stringify(teamData.members, null, 2));

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
const userInfo = wx.getStorageSync('userInfo') || app.globalData.userInfo;
const currentUserId = userInfo?.id;

const isCreator = teamData.creator.id === currentUserId;

this.setData({
  team: teamData,
  isCreator: isCreator,
  loading: false
});
```

**ä¿®æ”¹åçš„ä»£ç **ï¼š
```javascript
const teamData = await api.getTeamDetail(teamId);
console.log('ğŸ“Š å®Œæ•´çš„team.creator:', JSON.stringify(teamData.creator, null, 2));
console.log('ğŸ“Š å®Œæ•´çš„team.members:', JSON.stringify(teamData.members, null, 2));

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
const userInfo = wx.getStorageSync('userInfo') || app.globalData.userInfo;
const currentUserId = userInfo?.id;

// ğŸ”§ ä¿®å¤ï¼šå¦‚æœå½“å‰ç”¨æˆ·åœ¨æˆå‘˜åˆ—è¡¨ä¸­ï¼Œä½¿ç”¨APIè¿”å›çš„æ•°æ®æ›´æ–°localStorage
if (currentUserId) {
  // æŸ¥æ‰¾å½“å‰ç”¨æˆ·åœ¨æˆå‘˜åˆ—è¡¨ä¸­çš„æ•°æ®
  const currentUserInTeam = teamData.members.find(m => m.id === currentUserId);
  
  if (currentUserInTeam) {
    // ä½¿ç”¨APIè¿”å›çš„æœ€æ–°æ•°æ®ï¼ˆåŒ…å«æ°¸ä¹…å¤´åƒURLï¼‰
    const updatedUserInfo = {
      ...userInfo,
      nickname: currentUserInTeam.nickname || userInfo.nickname,
      avatar: currentUserInTeam.avatar || userInfo.avatar,
      campus: currentUserInTeam.campus || userInfo.campus
    };
    
    // æ›´æ–°localStorage
    wx.setStorageSync('userInfo', updatedUserInfo);
    
    // æ›´æ–°å…¨å±€æ•°æ®
    if (app.globalData) {
      app.globalData.userInfo = updatedUserInfo;
    }
    
    console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼ˆä½¿ç”¨APIæœ€æ–°æ•°æ®ï¼‰:', updatedUserInfo);
  }
  
  // å¦‚æœæ˜¯åˆ›å»ºè€…ï¼Œä¹Ÿæ›´æ–°åˆ›å»ºè€…æ•°æ®
  if (teamData.creator.id === currentUserId) {
    const updatedUserInfo = {
      ...userInfo,
      nickname: teamData.creator.nickname || userInfo.nickname,
      avatar: teamData.creator.avatar || userInfo.avatar,
      campus: teamData.creator.campus || userInfo.campus
    };
    
    wx.setStorageSync('userInfo', updatedUserInfo);
    
    if (app.globalData) {
      app.globalData.userInfo = updatedUserInfo;
    }
    
    console.log('âœ… åˆ›å»ºè€…ä¿¡æ¯å·²æ›´æ–°ï¼ˆä½¿ç”¨APIæœ€æ–°æ•°æ®ï¼‰:', updatedUserInfo);
  }
}

const isCreator = teamData.creator.id === currentUserId;

this.setData({
  team: teamData,
  isCreator: isCreator,
  loading: false
});
```

---

### æ–‡ä»¶2ï¼š`miniprogram/components/team-card/team-card.wxml` ï¼ˆå¦‚æœéœ€è¦ï¼‰

#### ä¿®æ”¹ä½ç½®ï¼šå¤´åƒæ˜¾ç¤ºéƒ¨åˆ†

**ç¡®ä¿ä½¿ç”¨teamæ•°æ®ä¸­çš„å¤´åƒ**ï¼š

**æ£€æŸ¥å½“å‰ä»£ç **ï¼ˆå¤§çº¦åœ¨æ˜¾ç¤ºåˆ›å»ºè€…å¤´åƒçš„åœ°æ–¹ï¼‰ï¼š
```xml
<image src="{{team.creator.avatar}}" />
```

**å¦‚æœä»£ç æ˜¯è¿™æ ·çš„ï¼ˆé”™è¯¯ï¼‰**ï¼š
```xml
<image src="{{userInfo.avatar}}" />
```

**åº”è¯¥æ”¹ä¸º**ï¼š
```xml
<image src="{{team.creator.avatar}}" />
```

---

## ğŸ¯ ä¿®æ”¹åŸç†

### é—®é¢˜æ ¹æº
1. localStorageç¼“å­˜äº†æ—§çš„ç”¨æˆ·æ•°æ®ï¼ˆä¸´æ—¶å¤´åƒURLï¼‰
2. åç«¯å·²æ›´æ–°ä¸ºæ°¸ä¹…URLï¼Œä½†å‰ç«¯è¿˜åœ¨ä½¿ç”¨ç¼“å­˜
3. APIè¿”å›çš„æ˜¯æœ€æ–°æ•°æ®ï¼ˆæ°¸ä¹…URLï¼‰

### è§£å†³é€»è¾‘
1. **ä¼˜å…ˆä½¿ç”¨APIæ•°æ®**ï¼šä»APIè¿”å›çš„teamæ•°æ®ä¸­è·å–å¤´åƒ
2. **è‡ªåŠ¨æ›´æ–°ç¼“å­˜**ï¼šå‘ç°å½“å‰ç”¨æˆ·åœ¨teamä¸­æ—¶ï¼Œç”¨APIæ•°æ®æ›´æ–°localStorage
3. **å…œåº•æœºåˆ¶**ï¼šä½¿ç”¨ `||` è¿ç®—ç¬¦ï¼ŒAPIæ•°æ®ä¼˜å…ˆ

---

## ğŸ“‹ ä¿®æ”¹æ­¥éª¤

### æ­¥éª¤1ï¼šæ‰“å¼€æ–‡ä»¶
æ‰“å¼€ `miniprogram/pages/team-detail/team-detail.js`

### æ­¥éª¤2ï¼šæ‰¾åˆ° `loadTeamDetail` æ–¹æ³•
æœç´¢ `loadTeamDetail` å‡½æ•°

### æ­¥éª¤3ï¼šæ‰¾åˆ°æ•°æ®å¤„ç†éƒ¨åˆ†
å®šä½åˆ°è¿™ä¸€è¡Œé™„è¿‘ï¼š
```javascript
const teamData = await api.getTeamDetail(teamId);
```

### æ­¥éª¤4ï¼šåœ¨ `this.setData` ä¹‹å‰æ·»åŠ æ›´æ–°é€»è¾‘
åœ¨ç°æœ‰ä»£ç çš„ `this.setData({...})` **ä¹‹å‰**æ’å…¥ä¸Šé¢çš„"ä¿®æ”¹åçš„ä»£ç "ä¸­æ ‡æ³¨äº† `ğŸ”§ ä¿®å¤` çš„é‚£æ®µä»£ç ã€‚

### æ­¥éª¤5ï¼šä¿å­˜å¹¶æµ‹è¯•
1. ä¿å­˜æ–‡ä»¶
2. é‡æ–°ç¼–è¯‘å°ç¨‹åº
3. è¿›å…¥ç»„é˜Ÿè¯¦æƒ…é¡µ
4. æ£€æŸ¥å¤´åƒæ˜¯å¦æ­£å¸¸æ˜¾ç¤º

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•å‰
å¤´åƒæ˜¾ç¤ºï¼š`http://tmp/xxxxx.png` ï¼ˆæ— æ³•åŠ è½½ï¼‰

### æµ‹è¯•å
å¤´åƒæ˜¾ç¤ºï¼š`https://thirdwx.qlogo.cn/...` æˆ– `https://nottingham-xxx.cos.ap-shanghai.myqcloud.com/...` ï¼ˆæ­£å¸¸æ˜¾ç¤ºï¼‰

### æ§åˆ¶å°è¾“å‡º
åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼ˆä½¿ç”¨APIæœ€æ–°æ•°æ®ï¼‰: {
  id: 1,
  nickname: "Markus",
  avatar: "https://thirdwx.qlogo.cn/...",
  campus: "University of Nottingham(Park)"
}
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

å¦‚æœä¿®æ”¹åè¿˜æ˜¯ä¸æ˜¾ç¤ºï¼Œæ£€æŸ¥ï¼š

1. **WXMLä¸­çš„å›¾ç‰‡ç»‘å®š**
   ```xml
   <!-- æ­£ç¡® -->
   <image src="{{team.creator.avatar}}" />
   
   <!-- é”™è¯¯ -->
   <image src="{{userInfo.avatar}}" />
   ```

2. **ç©ºå€¼å¤„ç†**
   å¦‚æœavatarä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å¤´åƒï¼š
   ```xml
   <image src="{{team.creator.avatar || '/images/default-avatar.png'}}" />
   ```

3. **æ§åˆ¶å°æ—¥å¿—**
   æ£€æŸ¥ `console.log` è¾“å‡ºï¼Œç¡®è®¤APIè¿”å›çš„avatarå€¼æ˜¯ä»€ä¹ˆ

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ–1ï¼šæ·»åŠ é»˜è®¤å¤´åƒ
```javascript
const defaultAvatar = '/images/default-avatar.png';

this.setData({
  team: {
    ...teamData,
    creator: {
      ...teamData.creator,
      avatar: teamData.creator.avatar || defaultAvatar
    },
    members: teamData.members.map(m => ({
      ...m,
      avatar: m.avatar || defaultAvatar
    }))
  }
});
```

### ä¼˜åŒ–2ï¼šæ·»åŠ å¤´åƒåŠ è½½å¤±è´¥å¤„ç†
```xml
<image 
  src="{{team.creator.avatar}}" 
  bind:error="onAvatarError"
/>
```

```javascript
onAvatarError(e) {
  console.error('å¤´åƒåŠ è½½å¤±è´¥:', e);
  // è®¾ç½®é»˜è®¤å¤´åƒ
  this.setData({
    'team.creator.avatar': '/images/default-avatar.png'
  });
}
```

---

## ğŸ“ ç»™IDEçš„æç¤ºè¯

```
è¯·ä¿®æ”¹ miniprogram/pages/team-detail/team-detail.js æ–‡ä»¶ä¸­çš„ loadTeamDetail æ–¹æ³•ã€‚

åœ¨è·å–åˆ° teamData åã€è°ƒç”¨ this.setData ä¹‹å‰ï¼Œæ·»åŠ ä»¥ä¸‹é€»è¾‘ï¼š

1. æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦åœ¨team.membersä¸­
2. å¦‚æœæ˜¯ï¼Œä½¿ç”¨APIè¿”å›çš„æœ€æ–°ç”¨æˆ·æ•°æ®ï¼ˆnickname, avatar, campusï¼‰æ›´æ–°localStorage
3. å¦‚æœå½“å‰ç”¨æˆ·æ˜¯åˆ›å»ºè€…ï¼Œä½¿ç”¨team.creatorçš„æ•°æ®æ›´æ–°localStorage

è¿™æ ·å¯ä»¥ç¡®ä¿localStorageä¸­å­˜å‚¨çš„æ˜¯æœ€æ–°çš„æ°¸ä¹…å¤´åƒURLï¼Œè€Œä¸æ˜¯å·²è¿‡æœŸçš„ä¸´æ—¶URLã€‚

å…³é”®ä»£ç ï¼š
- æŸ¥æ‰¾å½“å‰ç”¨æˆ·ï¼šteamData.members.find(m => m.id === currentUserId)
- æ›´æ–°ç¼“å­˜ï¼šwx.setStorageSync('userInfo', updatedUserInfo)
- æ›´æ–°å…¨å±€ï¼šapp.globalData.userInfo = updatedUserInfo

è¯·åœ¨é€‚å½“ä½ç½®æ·»åŠ console.logè¾“å‡ºï¼Œä¾¿äºè°ƒè¯•éªŒè¯ã€‚
```

---

**å®Œæˆä¿®æ”¹åï¼Œå¤´åƒåº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºäº†ï¼** ğŸ‰
